import React, { useEffect, useRef, useState } from "react";
import { Link, useLocation } from "react-router-dom";
import indecbrouchure from "../src/Brochure/indec_brouchure.pdf";
import "../src/Header.css";

const productLinks = [
  { to: "/product/mosquitonetwindows", label: "Mosquito Net Windows" },
  { to: "/product/mosquitonetdoors", label: "Mosquito Net Doors" },
  { to: "/product/curtains", label: "Curtains" },
  { to: "/product/blinds", label: "Blinds" },
  { to: "/product/vinylflooring", label: "Vinyl Flooring" },
  { to: "/product/wallpapers", label: "Wallpapers for Walls" },
];

// Throttle helper
const throttle = (func, limit) => {
  let inThrottle;
  return function () {
    const args = arguments;
    const context = this;
    if (!inThrottle) {
      func.apply(context, args);
      inThrottle = true;
      setTimeout(() => (inThrottle = false), limit);
    }
  };
};

export default function Header() {
  const { pathname } = useLocation();
  const [isMobileNavOpen, setIsMobileNavOpen] = useState(false);
  const [isProductsDropdownOpen, setIsProductsDropdownOpen] = useState(false);
  const [isScrolled, setIsScrolled] = useState(false);
  const [isMobile, setIsMobile] = useState(window.innerWidth <= 991);
  const dropdownRef = useRef(null);
  const navbarRef = useRef(null);

  // Resize listener
  useEffect(() => {
    const handleResize = () => {
      setIsMobile(window.innerWidth <= 991);
    };
    window.addEventListener("resize", handleResize);
    return () => window.removeEventListener("resize", handleResize);
  }, []);

  // Scroll listener
  useEffect(() => {
    const onScroll = throttle(() => {
      setIsScrolled(window.scrollY > 50);
    }, 100);
    window.addEventListener("scroll", onScroll);
    return () => window.removeEventListener("scroll", onScroll);
  }, []);

  // Close nav & dropdown when route changes
  useEffect(() => {
    setIsMobileNavOpen(false);
    setIsProductsDropdownOpen(false);
  }, [pathname]);

  // Close menus on outside click
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setIsProductsDropdownOpen(false);
      }
      if (
        navbarRef.current &&
        !navbarRef.current.contains(e.target) &&
        !e.target.closest(".mobile-nav-toggle")
      ) {
        setIsMobileNavOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Prevent background scroll on mobile open
  useEffect(() => {
    document.body.style.overflow = isMobileNavOpen ? "hidden" : "unset";
  }, [isMobileNavOpen]);

  // Dropdown handlers
  const handleProductsToggle = () => {
    if (isMobile) setIsProductsDropdownOpen((prev) => !prev);
  };

  const handleMouseEnter = () => {
    if (!isMobile) setIsProductsDropdownOpen(true);
  };

  const handleMouseLeave = () => {
    if (!isMobile) setIsProductsDropdownOpen(false);
  };

  return (
    <>
      <header
        id="header"
        className={`d-flex align-items-center ${isScrolled ? "header-scrolled" : ""}`}
      >
        <div className="container d-flex justify-content-between align-items-center">
          <div id="logo">
            <h1>
              <Link to="/">indec</Link>
            </h1>
          </div>

          {/* Mobile Nav Toggle */}
          <button
            className={`mobile-nav-toggle ${isMobileNavOpen ? "open" : ""}`}
            onClick={() => setIsMobileNavOpen((s) => !s)}
            aria-label="Toggle navigation"
          >
            <i className={`bi ${isMobileNavOpen ? "bi-x" : "bi-list"}`}></i>
          </button>

          {/* Navbar */}
          <nav
            id="navbar"
            className={`navbar ${isMobileNavOpen ? "navbar-mobile open" : ""}`}
            ref={navbarRef}
          >
            <ul>
              <li>
                <Link
                  to="/"
                  className={pathname === "/" ? "active" : ""}
                  onClick={() => setIsMobileNavOpen(false)}
                >
                  What we do
                </Link>
              </li>
              <li>
                <Link
                  to="/about"
                  className={pathname === "/about" ? "active" : ""}
                  onClick={() => setIsMobileNavOpen(false)}
                >
                  Who we are
                </Link>
              </li>
              <li>
                <Link
                  to="/services"
                  className={pathname === "/services" ? "active" : ""}
                  onClick={() => setIsMobileNavOpen(false)}
                >
                  Services
                </Link>
              </li>

              {/* Dropdown */}
              <li
                className={`dropdown ${isProductsDropdownOpen ? "dropdown-active" : ""}`}
                ref={dropdownRef}
                onMouseEnter={handleMouseEnter}
                onMouseLeave={handleMouseLeave}
              >
                <button
                  type="button"
                  className="dropdown-toggle"
                  onClick={handleProductsToggle}
                >
                  Products
                  <i className={`bi ${isProductsDropdownOpen ? "bi-chevron-up" : "bi-chevron-down"}`}></i>
                </button>
                <ul className={`dropdown-menu ${isProductsDropdownOpen ? "show" : ""}`}>
                  {productLinks.map((p) => (
                    <li key={p.to}>
                      <Link
                        to={p.to}
                        className={pathname === p.to ? "active" : ""}
                        onClick={() => {
                          setIsMobileNavOpen(false);
                          setIsProductsDropdownOpen(false);
                        }}
                      >
                        {p.label}
                      </Link>
                    </li>
                  ))}
                </ul>
              </li>

              <li>
                <Link
                  to="/contact"
                  className={pathname === "/contact" ? "active" : ""}
                  onClick={() => setIsMobileNavOpen(false)}
                >
                  Contact
                </Link>
              </li>

              <li>
                <a
                  href={indecbrouchure}
                  target="_blank"
                  rel="noreferrer"
                  className="brochure-btn"
                  onClick={() => setIsMobileNavOpen(false)}
                >
                  Brochure
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </header>

      {/* Overlay for mobile */}
      {isMobileNavOpen && (
        <div className="navbar-overlay" onClick={() => setIsMobileNavOpen(false)} />
      )}
    </>
  );
}
